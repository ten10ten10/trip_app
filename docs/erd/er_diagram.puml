@startuml

object User {
  <#white>| <b>Data Type</b> | <b>Column Name</b> | <b>Constraints</b> | <b>Nullability</b> |
  <#white>| uuid | id | PK | NOT NULL |
  <#white>| varchar(255) | name | | NOT NULL |
  <#white>| varchar(255) | email | UQ | NOT NULL |
  <#white>| varchar(255) | password_hash | | NOT NULL |
  <#white>| boolean | is_active | | NOT NULL |
  <#white>| varchar(255) | verification_token_hash | UQ | |
  <#white>| timestamptz | createdAt | DEFAULT now() | NOT NULL |
  <#white>| timestamptz | updatedAt | DEFAULT now() | NOT NULL |
}
note right of User
  <b>ID生成方針:</b>
    - UUIDv7などの時間順UUID + uuid型を推奨
  <b>パスワード:</b>
    - Argon2等OWASP準拠ソルト付きハッシュ
  <b>検証トークン:</b>
    - 期限付きでの発行・ハッシュ保存（必要に応じてexpires列を別途設計）
end note

object Trip {
  <#white>| <b>Data Type</b> | <b>Column Name</b> | <b>Constraints</b> | <b>Nullability</b> |
  <#white>| uuid | id | PK | NOT NULL |
  <#white>| uuid | userId | FK (ON DELETE CASCADE) | NOT NULL |
  <#white>| varchar(255) | title | | NOT NULL |
  <#white>| date | startDate | | NOT NULL |
  <#white>| date | endDate | | NOT NULL |
  <#white>| timestamptz | createdAt | DEFAULT now() | NOT NULL |
  <#white>| timestamptz | updatedAt | DEFAULT now() | NOT NULL |
}
note right of Trip
  <b>CHECK制約:</b>
    - endDate >= startDate をDBで設定
end note

object Schedule {
  <#white>| <b>Data Type</b> | <b>Column Name</b> | <b>Constraints</b> | <b>Nullability</b> |
  <#white>| uuid | id | PK | NOT NULL |
  <#white>| uuid | tripId | FK (ON DELETE CASCADE) | NOT NULL |
  <#white>| varchar(255) | title | | NOT NULL |
  <#white>| timestamptz | startDateTime | | NOT NULL |
  <#white>| timestamptz | endDateTime | | NOT NULL |
  <#white>| text | memo | | |
  <#white>| timestamptz | createdAt | DEFAULT now() | NOT NULL |
  <#white>| timestamptz | updatedAt | DEFAULT now() | NOT NULL |
}
note bottom of Schedule
  <b>CHECK制約:</b>
    - startDateTime < endDateTime
  <b>アプリ制約:</b>
    - 親Tripの期間内に限る（他テーブル参照範囲はアプリで担保）
end note

object Member {
  <#white>| <b>Data Type</b> | <b>Column Name</b> | <b>Constraints</b> | <b>Nullability</b> |
  <#white>| uuid | id | PK | NOT NULL |
  <#white>| uuid | tripId | FK (ON DELETE CASCADE) | NOT NULL |
  <#white>| varchar(255) | name | | NOT NULL |
}

object ShareToken {
  <#white>| <b>Data Type</b> | <b>Column Name</b> | <b>Constraints</b> | <b>Nullability</b> |
  <#white>| uuid | tripId | FK (ON DELETE CASCADE), PK | NOT NULL |
  <#white>| varchar(255) | token_hash | UQ | NOT NULL |
  <#white>| timestamptz | createdAt | DEFAULT now() | NOT NULL |
  <#white>| timestamptz | updatedAt | DEFAULT now() | NOT NULL |
}
note bottom of ShareToken
  <b>共有用トークン:</b>
    - 有効期限なし運用（ローテーション + 監査updatedAt）
    - token_hashは衝突防止のためUNIQUE
end note

User }o--|| Trip
Trip }o--|| Schedule
Trip }o--|| Member
Trip ||--|| ShareToken

@enduml
